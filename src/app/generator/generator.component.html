<div class="p-3">
    @if (loggedIn) {
    <h1 class="text-4xl mb-4">T·∫°o khuy·∫øn m√£i</h1>
    @if (generatorBrandSetting?.voucherForms) {
    <mat-expansion-panel [expanded]="true">
        <mat-expansion-panel-header>
            <mat-panel-title>Th√¥ng tin chung</mat-panel-title>
            <mat-panel-description>Th√¥ng tin chung c·ªßa khuy·∫øn m√£i</mat-panel-description>
        </mat-expansion-panel-header>
        <mat-form-field class="w-full">
            <mat-label>M√£ khuy·∫øn m√£i</mat-label>
            <input type="text" matInput required [(ngModel)]="voucher.id" />
            <span matTextPrefix>{{generatorBrandSetting?.id}}-</span>
        </mat-form-field>
        <mat-form-field class="w-full">
            <mat-label>T√™n g·ªçi khuy·∫øn m√£i</mat-label>
            <input type="text" matInput required [(ngModel)]="voucher.name" />
        </mat-form-field>
    </mat-expansion-panel>
    <mat-expansion-panel [expanded]="true">
        <mat-expansion-panel-header>
            <mat-panel-title>Thi·∫øt k·∫ø</mat-panel-title>
            <mat-panel-description>Thi·∫øt k·∫ø c·ªßa khuy·∫øn m√£i</mat-panel-description>
        </mat-expansion-panel-header>
        <div>
            <mat-form-field class="w-full">
                <mat-label>M√£ h√¨nh n·ªÅn</mat-label>
                <input type="text" matInput required [(ngModel)]="voucher.background"
                    (ngModelChange)="onAddBackground()" />
                <mat-hint>Id c·ªßa ·∫£nh tr√™n Google Drive</mat-hint>
            </mat-form-field>
            @if (voucher?.sharedBackground) {
            H√£y truy c·∫≠p ngay: <a [href]="voucher?.sharedBackground" [target]="'_blank'"
                class="underline text-[red]">{{voucher?.sharedBackground}}</a> ƒë·ªÉ l·∫•y <strong>M√£
                h√¨nh n·ªÅn </strong>ch√≠nh x√°c.
            }
            <mat-form-field class="w-full">
                <mat-label>M√£/li√™n k·∫øt h√¨nh n·ªÅn <strong class="text-[red]">ch√≠nh x√°c</strong></mat-label>
                <input type="text" matInput required [(ngModel)]="voucher.correctBackground"
                    (ngModelChange)="onAddBackground()" />
            </mat-form-field>
            <mat-form-field class="w-full">
                <mat-label>K√≠ch th∆∞·ªõc h√¨nh ·∫£nh khuy·∫øn m√£i</mat-label>
                <input type="text" disabled matInput required [(ngModel)]="voucher.size" />
                <mat-hint [innerText]="'\<ngang\>x\<d·ªçc\>'"></mat-hint>
            </mat-form-field>
            <mat-form-field class="w-full">
                <mat-label>K√≠ch th∆∞·ªõc m√£ QR trong khuy·∫øn m√£i</mat-label>
                <input type="number" matInput required [(ngModel)]="voucher.qrSize" (ngModelChange)="updateQr()" />
                <mat-hint [innerText]="'h√¨nh vu√¥ng'"></mat-hint>
            </mat-form-field>
            <mat-form-field class="w-full">
                <mat-label>T·ªça ƒë·ªô m√£ QR trong khuy·∫øn m√£i</mat-label>
                <input type="text" matInput required [(ngModel)]="voucher.qrPosition"
                    (ngModelChange)="updateQrPosition()" />
                <mat-hint [innerText]="'\<x\>:\<y\>'"></mat-hint>
            </mat-form-field>
        </div>

        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>Khuy·∫øn m√£i t√≠ch ƒëi·ªÉm</mat-panel-title>
                <mat-panel-description>Thi·∫øt k·∫ø c·ªßa khuy·∫øn m√£i t√≠ch ƒëi·ªÉm</mat-panel-description>
            </mat-expansion-panel-header>
            <div>
                <mat-form-field class="w-full">
                    <mat-label>M√£ tick</mat-label>
                    <input type="text" matInput [(ngModel)]="voucher.tickId" (ngModelChange)="updateTickImage()" />
                </mat-form-field>

                @if (voucher?.shareTick) {
                H√£y truy c·∫≠p ngay: <a [href]="voucher?.shareTick" [target]="'_blank'"
                    class="underline text-[red]">{{voucher?.shareTick}}</a> ƒë·ªÉ l·∫•y <strong>M√£
                    tick </strong>ch√≠nh x√°c.
                }
                <mat-form-field class="w-full">
                    <mat-label>M√£/li√™n k·∫øt tick <strong class="text-[red]">ch√≠nh x√°c</strong></mat-label>
                    <input type="text" matInput [(ngModel)]="voucher.correctTick" (ngModelChange)="updateTickImage()" />
                </mat-form-field>
                @if (voucher?.tickImage) {
                <img [src]="voucher?.tickImage" class="h-8" alt="tickImage" (load)="uploadTick($event)">
                }
                <div class="w-full flex flex-wrap">
                    @for (item of voucher?.ticks; track item; let index = $index) {
                    <div class="w-full lg:w-1/3">
                        <strong>Tick {{index + 1 | number: '2.0-0'}}: </strong>
                        <mat-divider></mat-divider>
                        <mat-form-field class="w-full lg:w-1/2">
                            <mat-label>K√≠ch th∆∞·ªõc tick {{index + 1 | number: '2.0-0'}}</mat-label>
                            <input type="number" matInput [(ngModel)]="item.size" (ngModelChange)="uploadTick(item)" />
                            <mat-hint [innerText]="'h√¨nh vu√¥ng'"></mat-hint>
                        </mat-form-field>
                    </div>
                    }
                    @if (voucher?.tickImage) {
                    <button mat-stroked-button [color]="'primary'" class="w-full lg:w-1/3"
                        (click)="uploadTick('add')">Th√™m
                        tick</button>
                    }
                </div>

            </div>
        </mat-expansion-panel>
        @if (downloading) {
        <div class="absolute top-0 right-0 bottom-0 left-0 flex justify-center items-center">
            <mat-spinner></mat-spinner>
        </div>
        }
        <div #voucherContainer class="h-96 w-full border relative z-10 select-none" [id]="'voucherContainerId'" [style]="{
                    height: voucher.height ? (voucher.height + 'px') : '',
                    width: voucher.width ? (voucher.width + 'px') : '',
                    }">
            <div [style]="{
                        height: voucher.qrSize + 'px',
                        width: voucher.qrSize + 'px',
                        transform: 'translate3d(' + voucher.qrX +'px, ' + voucher.qrY + 'px, 0px)'
                    }"
                class="absolute top-0 left-0 border flex justify-center items-center cursor-move origin-center bg-white z-10"
                [cdkDragDisabled]="!voucher?.backgroundImage" cdkDragBoundary="#voucherContainerId" cdkDrag
                (cdkDragEnded)="updateQrPosition($event)">
                @if(voucher.id) {
                <qrcode #sync [qrdata]="voucher.id" [width]="voucher.qrSize" [imageHeight]="voucher.qrIconSize"
                    [imageWidth]="voucher.qrIconSize" [cssClass]="'flex justify-center'" [errorCorrectionLevel]="'M'"
                    [colorDark]="'#000000ff'" [colorLight]="'#ffffffff'" [elementType]="'canvas'" [margin]="4"
                    [scale]="128"></qrcode>
                } @else {
                QR
                }
            </div>
            @for (item of voucher?.ticks; track item) {
            <div [style]="{
                                height: item.size + 'px',
                                width: item.size + 'px',
                                transform: 'translate3d(' + item.x +'px, ' + item.y + 'px, 0px)'
                            }"
                class="absolute top-0 left-0 flex justify-center items-center cursor-move origin-center z-20"
                [cdkDragDisabled]="!voucher?.backgroundImage" cdkDragBoundary="#voucherContainerId" cdkDrag
                (cdkDragEnded)="uploadTick($event, item)">
                <img [src]="voucher?.tickImage" alt="tickImage">
            </div>
            }
            @if (voucher?.backgroundImage) {
            <img [src]="voucher?.backgroundImage" alt="background" (load)="updateImageSize($event)"
                class="absolute top-0 right-0 bottom-0 left-0">
            } @else {
            <div class="absolute top-0 right-0 bottom-0 left-0 flex justify-center items-center text-center text-lg">
                H√£y th·ª±c hi·ªán c√°c b∆∞·ªõc <strong class="text-[red] mx-1"> ch√≠nh x√°c</strong> ·ªü ph√≠a tr√™n th√¨ b·∫°n m·ªõi c√≥
                th·ªÉ ti·∫øn h√†nh ch·ªânh s·ª≠a khuy·∫øn m√£i
            </div>
            }
        </div>
        <div class="text-center mb-6">
            <button mat-stroked-button color="primary" (click)="saveAsImage(voucherContainer)" [disabled]="downloading">
                <mat-icon>download</mat-icon> T·∫£i ·∫£nh chia s·∫ª
            </button>
        </div>
        <div class="text-center">
            <button mat-raised-button color="primary" (click)="saveData()" [disabled]="downloading" class="w-full">
                <mat-icon>save</mat-icon> L∆∞u D·ªØ Li·ªáu M·∫´u Khuy·∫øn M√£i
            </button>
        </div>
        @if (googleFormsPath) {
        <button class="w-full" mat-stroked-button [color]="'primary'" (click)="googleFormsPath = ''">ƒê√≥ng bi·ªÉu
            m·∫´u</button>
        <div><strong class="text-[red]">L∆ØU √ù:</strong> H√£y ·∫§n n√∫t "G·ª≠i" ho·∫∑c "Submit" trong Bi·ªÖu M·∫´u b√™n d∆∞·ªõi üëáüëáüëá
            th√¨ b·∫°n m·ªõi ho√†n th√†nh vi·ªác ƒëƒÉng k√Ω nh√©!</div>
        <div><strong class="text-[red]">L∆ØU √ù:</strong> M·ªói khi ho√†n th√†nh vi·ªác t·∫°o b·∫°n nh·ªõ ·∫•n n√∫t "ƒê√≥ng bi·ªÉu m·∫´u ƒë·ªÉ l√†m
            m·ªõi nh√©!"</div>
        <iframe [src]="googleFormsPath | safe" class="w-full min-h-96" frameborder="0"></iframe>
        <div><strong class="text-[red]">L∆ØU √ù:</strong> H√£y ·∫§n n√∫t "G·ª≠i" ho·∫∑c "Submit" trong Bi·ªÖu M·∫´u b√™n tr√™n üëÜüëÜüëÜ
            th√¨ b·∫°n m·ªõi ho√†n th√†nh vi·ªác ƒëƒÉng k√Ω nh√©!</div>
        <div><strong class="text-[red]">L∆ØU √ù:</strong> M·ªói khi ho√†n th√†nh vi·ªác t·∫°o b·∫°n nh·ªõ ·∫•n n√∫t "ƒê√≥ng bi·ªÉu m·∫´u ƒë·ªÉ l√†m
            m·ªõi nh√©!"</div>
        }
    </mat-expansion-panel>
    } @else {
    <div class="h-full flex justify-center items-center flex-col">
        <div>ƒêang t√¨m ki·∫øm bi·ªÉu m·∫´u t·∫°o khuy·∫øn m√£i c·ªßa b·∫°n</div>
        <mat-spinner></mat-spinner>
    </div>
    }
    }
</div>